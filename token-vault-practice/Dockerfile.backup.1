FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# Clean and install deps
RUN rm -rf /var/lib/apt/lists/* \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
        curl \
        build-essential \
        libssl-dev \
        pkg-config \
        libudev-dev \
        git \
        ca-certificates \
        unzip \
    && rm -rf /var/lib/apt/lists/*

# Rust (already in PATH via ENV below)
# Install Rust and set to latest nightly for edition2024 support
# Edition 2024 requires Cargo 1.86.0+ (Rust 1.85+), which is available in nightly
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
    && . "$HOME/.cargo/env" \
    && rustup toolchain install nightly \
    && rustup default nightly \
    && rustup component add rustfmt clippy --toolchain nightly \
    && rustup update nightly 

# Modern all-in-one installer
RUN curl -sSfL https://solana-install.solana.workers.dev | bash \
    && . "$HOME/.bashrc"  # Source immediately to pick up any appended exports

# Make PATH persistent across layers (critical!)
# Put cargo/bin BEFORE solana/bin to ensure we use rustup's cargo, not solana's
ENV PATH="/root/.cargo/bin:/root/.local/share/solana/install/active_release/bin:${PATH}"

# Optional: Pin Anchor version for Blueshift course consistency (check your course for exact, e.g. 0.29.0 or 0.30.1)
# RUN avm install 0.30.1 && avm use 0.30.1

# Clear entire Cargo registry to avoid old Cargo version issues
# This ensures registry metadata matches the Cargo version we're using
RUN rm -rf /root/.cargo/registry/cache \
    && rm -rf /root/.cargo/registry/src \
    && rm -rf /root/.cargo/registry/index

# Verify installations (now solana/anchor should be found)
RUN rustc --version && \
    cargo --version && \
    solana --version && \
    anchor --version

SHELL ["/bin/bash", "-c"]